<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Horários Livres</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1 { margin-bottom: .5rem; }
    ul { list-style: none; padding: 0; }
    li { margin: .25rem 0; }
    .erro { color: red; }
  </style>
</head>
<body>
  <h1>Horários Livres nos Próximos 7 Dias</h1>
  <ul id="lista-livres"></ul>
  <p id="msg" class="erro" style="display:none;">
    Não foi possível carregar os horários. Veja o console para detalhes.
  </p>

  <script>
    const ICS_URL = 
      'https://calendar.google.com/calendar/ical/' +
      '2c5a92869999fb7b7cacc691a09414de427c5926f2db01ec6e427bd6eb8e6a9d%40group.calendar.google.com/' +
      'public/basic.ics';
    const PROXY_URL = 'https://api.allorigins.win/raw?url=';
    const DAYS_AHEAD = 7, START_HOUR = 9, END_HOUR = 22;

    function parseEvents(txt) {
      const lines = txt.split(/\r?\n/), evs = [];
      let inE=false, s, e;
      for (const l of lines) {
        if (l==='BEGIN:VEVENT') { inE=true; s=e=null; }
        if (inE && l.startsWith('DTSTART')) s=parseICSTime(l);
        if (inE && l.startsWith('DTEND'  )) e=parseICSTime(l);
        if (l==='END:VEVENT') {
          if (s&&e) evs.push({start:s,end:e});
          inE=false;
        }
      }
      return evs;
    }
    function parseICSTime(line) {
      const part = line.split(':').pop();
      const Y=+part.substr(0,4), M=+part.substr(4,2)-1,
            D=+part.substr(6,2), h=+part.substr(9,2),
            m=+part.substr(11,2);
      return new Date(Y,M,D,h,m);
    }
    function computeFreeSlots(events) {
      events.sort((a,b)=>a.start-b.start);
      const free = [], today=new Date();
      for (let i=0;i<DAYS_AHEAD;i++) {
        const day = new Date(today.getFullYear(), today.getMonth(), today.getDate()+i);
        const ds = new Date(day), de = new Date(day);
        ds.setHours(START_HOUR,0,0,0); de.setHours(END_HOUR,0,0,0);
        const busy = events
          .filter(ev => ev.end>ds && ev.start<de)
          .map(ev => ({
            start: ev.start<ds ? ds : ev.start,
            end:   ev.end>de   ? de : ev.end
          }));
        let cursor = ds;
        busy.forEach(ev => {
          if (ev.start>cursor) free.push({start:cursor,end:ev.start});
          cursor = ev.end>cursor ? ev.end : cursor;
        });
        if (cursor<de) free.push({start:cursor,end:de});
      }
      return free;
    }

    fetch(PROXY_URL + encodeURIComponent(ICS_URL))
      .then(r => r.text())
      .then(txt => {
        const evs = parseEvents(txt), livres = computeFreeSlots(evs);
        const ul = document.getElementById('lista-livres');
        if (livres.length===0) {
          ul.innerHTML = '<li>Nenhum horário livre encontrado.</li>';
        } else {
          livres.forEach(slot => {
            const li = document.createElement('li');
            li.textContent = 
              slot.start.toLocaleString('pt-BR',{dateStyle:'short',timeStyle:'short'}) +
              ' – ' +
              slot.end.toLocaleTimeString('pt-BR',{timeStyle:'short'});
            ul.appendChild(li);
          });
        }
      })
      .catch(err => {
        console.error('Erro ao carregar ICS:', err);
        document.getElementById('msg').style.display = 'block';
      });
  </script>
</body>
</html>
